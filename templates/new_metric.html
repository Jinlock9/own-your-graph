{% extends "base.html" %}
{% block title %}New Metric — own/graph{% endblock %}
{% block extra_head %}
<style>
  .mode-card {
    display: block;
    padding: 1rem 1.1rem;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
    background: var(--bg);
    user-select: none;
  }
  .mode-card:hover {
    border-color: rgba(0,229,255,0.4);
    background: rgba(0,229,255,0.03);
  }
  .mode-card.selected {
    border-color: var(--accent);
    background: rgba(0,229,255,0.07);
    box-shadow: 0 0 0 1px var(--accent);
  }
  .mode-card-title {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.3rem;
  }
  .mode-card.selected .mode-card-title { color: var(--accent); }
  .mode-card-desc {
    font-size: 0.68rem;
    color: var(--text-dim);
    line-height: 1.4;
  }
  .series-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    border: 1px solid rgba(255,171,64,0.35);
    background: rgba(255,171,64,0.07);
    color: var(--warn);
    font-size: 0.72rem;
    letter-spacing: 0.04em;
    border-radius: 2px;
  }
  .series-tag-remove {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 0.85rem;
    line-height: 1;
  }
  .series-tag-remove:hover { color: var(--accent2); }
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title"><span>//</span> New Metric</div>
  <a href="/" class="btn">← Back</a>
</div>

<div style="max-width:520px;">
  <div class="card">
    {% if error %}<div class="error-msg">{{ error }}</div>{% endif %}
    <form method="post" action="/metrics/new" onsubmit="return prepareSubmit()">
      <div class="form-group">
        <label for="name">Metric Name *</label>
        <input type="text" id="name" name="name" placeholder="e.g. matmul_kernel_cycles" required>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <input type="text" id="description" name="description" placeholder="e.g. GEMM 1024x1024 cycle count on A100">
      </div>
      <div class="form-group">
        <label for="unit">Unit</label>
        <input type="text" id="unit" name="unit" placeholder="e.g. cycles, ms, kg, reps">
      </div>
      <div class="form-group">
        <label for="lower_better">Goal Direction</label>
        <select id="lower_better" name="lower_better">
          <option value="1">Lower is better</option>
          <option value="0">Higher is better</option>
        </select>
      </div>

      <!-- Graph Mode -->
      <div class="form-group">
        <label>Graph Mode</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
          <label class="mode-card selected" id="card-single">
            <input type="radio" name="graph_mode" value="single" checked
                   style="display:none;" onchange="selectMode('single')">
            <div class="mode-card-title">Single Graph</div>
            <div class="mode-card-desc">One unified timeline — all entries on a single chart.</div>
          </label>
          <label class="mode-card" id="card-multi">
            <input type="radio" name="graph_mode" value="multi"
                   style="display:none;" onchange="selectMode('multi')">
            <div class="mode-card-title">Multi Graph</div>
            <div class="mode-card-desc">Multiple named series — view them combined or in separate windows.</div>
          </label>
        </div>
      </div>

      <!-- Series builder (multi mode only) -->
      <div id="series-builder" style="display:none;">
        <div class="form-group" style="margin-bottom:0.5rem;">
          <label>Series</label>
          <div style="display:flex;gap:0.5rem;">
            <input type="text" id="series-input" placeholder="e.g. benchmark_A"
                   style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addSeries();}">
            <button type="button" class="btn" style="white-space:nowrap;" onclick="addSeries()">+ Add</button>
          </div>
          <div style="font-size:0.65rem;color:var(--text-dim);margin-top:0.3rem;">
            Add each series you'll track (e.g. different benchmarks or configurations)
          </div>
        </div>
        <div id="series-tags" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1rem;min-height:1.5rem;"></div>
        <!-- Submitted as comma-separated string -->
        <input type="hidden" name="series_names" id="series-names-hidden" value="">
      </div>

      <button type="submit" class="btn" style="width:100%;justify-content:center;padding:0.75rem;">
        Create Metric →
      </button>
    </form>
  </div>
</div>

<script>
  let seriesList = [];

  function selectMode(mode) {
    document.getElementById('card-single').classList.toggle('selected', mode === 'single');
    document.getElementById('card-multi').classList.toggle('selected', mode === 'multi');
    document.getElementById('series-builder').style.display = mode === 'multi' ? 'block' : 'none';
  }

  // Allow clicking anywhere on the card to select it
  ['card-single', 'card-multi'].forEach(id => {
    document.getElementById(id).addEventListener('click', function() {
      const radio = this.querySelector('input[type="radio"]');
      radio.checked = true;
      selectMode(radio.value);
    });
  });

  function addSeries() {
    const inp = document.getElementById('series-input');
    const val = inp.value.trim();
    inp.value = '';
    if (!val || seriesList.includes(val)) return;
    seriesList.push(val);
    renderTags();
  }

  function removeSeries(val) {
    seriesList = seriesList.filter(s => s !== val);
    renderTags();
  }

  function renderTags() {
    const container = document.getElementById('series-tags');
    container.innerHTML = seriesList.map(s =>
      `<span class="series-tag">${escHtml(s)}<span class="series-tag-remove" onclick="removeSeries(${JSON.stringify(s)})">×</span></span>`
    ).join('');
    document.getElementById('series-names-hidden').value = seriesList.join(',');
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function prepareSubmit() {
    // Ensure hidden field is up to date (already synced, but just in case)
    document.getElementById('series-names-hidden').value = seriesList.join(',');
    return true;
  }
</script>
{% endblock %}
